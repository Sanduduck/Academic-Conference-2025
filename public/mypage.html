<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>마이페이지</title>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
    :root{--bd:#e6e6e8;--text:#111;--muted:#666;--shadow:0 10px 30px rgba(0,0,0,.12);}
    body{margin:0;font:14px/1.6 Pretendard,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR;color:var(--text);background:#f7f7f8}
    .wrap{max-width:1000px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--bd);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    h2{margin:0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:14px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
    .thumb{aspect-ratio:1.3/1;background:#e9e9ee;background-size:cover;background-position:center}
    .meta{padding:10px}
    .meta .title{font-weight:700}
    .meta .sub{color:var(--muted);font-size:.9rem}
    .actions{display:flex;gap:8px;justify-content:flex-end;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h2>마이페이지</h2>
      <div>
        <a class="btn" href="/"><i class='bx bx-home'></i>메인</a>
        <button id="btnLogout" class="btn"><i class='bx bx-log-out'></i>로그아웃</button>
      </div>
    </div>

    <div style="margin-top:8px;color:#666">북마크한 모델 <b id="cnt">0</b>개</div>
    <div class="grid" id="list"></div>
  </div>

  <script>
    const qs=s=>document.querySelector(s);
    async function api(path, method='GET', body){
      const res = await fetch(path, {
        method,
        headers: body instanceof FormData ? undefined : { 'Content-Type':'application/json' },
        credentials: 'include',
        body: body ? (body instanceof FormData ? body : JSON.stringify(body)) : undefined
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw Object.assign(new Error(data.error||'요청 실패'), { status: res.status, data });
      return data;
    }

    async function load(){
      // 로그인 확인
      try{
        const me = await api('/api/auth/whoami');
        if(!me?.user || me.user.role === 'admin'){ location.href='/'; return; }
      }catch{ location.href='/'; return; }

      try{
        const r = await api('/api/bookmarks');
        const items = r.items || [];
        qs('#cnt').textContent = items.length;
        qs('#list').innerHTML = items.map(m=>{
          const bg = m.thumb ? `style="background-image:url('${String(m.thumb).replace(/'/g,"%27")}')"` : '';
          return `
            <article class="card" data-id="${m.id}">
              <div class="thumb" ${bg}></div>
              <div class="meta">
                <div class="title">${m.title}</div>
                <div class="sub">${m.description||''}</div>
              </div>
              <div class="actions">
                <button class="btn btn-remove"><i class='bx bx-bookmark-x'></i>해제</button>
                <a class="btn" href="/" onclick="event.preventDefault(); window.open('/', '_self');"><i class='bx bx-show'></i>메인에서 보기</a>
              </div>
            </article>
          `;
        }).join('');

        // 해제 버튼
        document.querySelectorAll('.btn-remove').forEach(b=>{
          b.addEventListener('click', async ()=>{
            const id = b.closest('.card')?.dataset?.id;
            if(!id) return;
            try{
              await api(`/api/bookmarks/${id}`, 'DELETE');
              b.closest('.card').remove();
              qs('#cnt').textContent = document.querySelectorAll('.card').length;
            }catch(err){ alert('해제 실패: ' + (err.message||'ERR')); }
          });
        });

      }catch(err){
        console.warn(err);
        qs('#list').innerHTML = `<div style="grid-column:1/-1;color:#a00">불러오기 실패</div>`;
      }
    }

    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      try{ await api('/api/auth/logout','POST'); }catch{}
      location.href='/';
    });

    load();
  </script>
</body>
</html>
