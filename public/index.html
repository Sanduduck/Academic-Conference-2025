<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÍµêÏú°Ïö© Î™®Îç∏ Ïπ¥ÌÉàÎ°úÍ∑∏</title>
  <meta name="description" content="ÌååÏùº(models.json) ÎòêÎäî /api/models Í∏∞Î∞ò ÍµêÏú°Ïö© Î™®Îç∏ Ïπ¥ÌÉàÎ°úÍ∑∏. Í≥ºÎ™© ÌïÑÌÑ∞ + Î°úÍ∑∏Ïù∏/Î°úÍ∑∏ÏïÑÏõÉ + ÎßàÏù¥ÌéòÏù¥ÏßÄ(+Í¥ÄÎ¶¨Ïûê Ï∞®Îã®) + Sketchfab ÏûÑÎ≤†Îìú ÌåùÏóÖ." />
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>

  <style>
    :root {
      --c1:#bc2c3c; --c2:#4e77ba; --bg:#f7f7f8; --card:#fff; --text:#111; --muted:#666; --bd:#e6e6e8;
      --ring:#4e77ba; --danger:#e63946; --ok:#16a34a; --shadow:0 10px 30px rgba(0,0,0,.12); --radius:16px;
      --login-color:#4AD395;--login-dark:#23004d;--login-light:#a49eac;--login-lighten:#f2f2f2;--login-hover:#65bf97;
      --login-font:"Open Sans", sans-serif;--login-big:1.5rem;--login-normal:0.938rem;--login-small:0.813rem;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font:14px/1.6 Pretendard,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR;color:var(--text);background:var(--bg)}
    .no-scroll{overflow:hidden}
    .container{max-width:1280px;margin:0 auto;padding:0 16px}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--bd)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px;gap:12px}
    .brand{display:inline-flex;align-items:center;gap:.6rem;font-weight:800;text-decoration:none;color:var(--text)}
    .brand:hover{opacity:.85}
    .logo{width:28px;height:28px;border-radius:9px;background:linear-gradient(135deg,var(--c1),var(--c2))}
    .search{flex:1;display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--bd);border-radius:14px;padding:8px 10px;margin:0 16px}
    .search input{border:0;outline:0;flex:1;font:inherit}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--bd);background:#fff;border-radius:12px;padding:8px 12px;text-decoration:none;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,var(--c1),var(--c2));border:none;color:#fff;box-shadow:var(--shadow)}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:#333}

    /* Filter Bar */
    .filterbar{background:#fff;border-top:1px solid var(--bd);border-bottom:1px solid var(--bd)}
    .filters{display:flex;align-items:center;flex-wrap:wrap;gap:12px;padding:10px 0}
    .filters .group{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .filters input[type="checkbox"]{width:16px;height:16px}
    .filters label{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;cursor:pointer;user-select:none}
    .filters .clear{margin-left:auto}

    /* Layout */
    main{padding:16px 0}
    .results{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}
    @media(max-width:1200px){.results{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.results{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.results{grid-template-columns:1fr}}

    .item{display:flex;flex-direction:column;overflow:hidden;background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);position:relative}
    .thumb{
      aspect-ratio:1.2/1;background:#e9e9ee;display:grid;place-items:center;color:#888;
      border-bottom:1px solid var(--bd);cursor:pointer;position:relative;background-size:cover;background-position:center;background-repeat:no-repeat
    }
    .thumb::after{
      content:"ÌÅ¥Î¶≠ÌïòÏó¨ ÎØ∏Î¶¨Î≥¥Í∏∞";position:absolute;bottom:8px;right:8px;background:rgba(17,17,17,.75);
      color:#fff;font-size:.75rem;padding:4px 8px;border-radius:8px;z-index:1;pointer-events:none;
    }
    /* ÏÇ≠Ï†ú Î≤ÑÌäº: Î©îÏù∏ÏóêÏÑúÎäî Ìï≠ÏÉÅ Ïà®ÍπÄ(Í¥ÄÎ¶¨Ïûê Í∏∞Îä•ÏùÄ /admin Ï†ÑÏö©) */
    .thumb-del{ display:none; }

    /* ‚òÖ Î∂ÅÎßàÌÅ¨ Î≤ÑÌäº: Ïö∞ÏÉÅÎã®ÏúºÎ°ú Ïù¥Îèô */
    .bookmark-btn{
      position:absolute;top:8px;right:8px;left:auto;
      z-index:2;width:32px;height:32px;border-radius:50%;
      display:inline-grid;place-items:center;
      background:rgba(255,255,255,.95);border:1px solid var(--bd);
      cursor:pointer;box-shadow:var(--shadow);line-height:1;
    }
    .bookmark-btn i{font-size:18px}
    .bookmark-btn.active{background:#fff}
    .bookmark-btn:hover{filter:brightness(.96)}

    .meta{padding:10px;text-align:left}
    .title{font-weight:700;text-align:left}
    .sub{color:var(--muted);font-size:.85rem;margin-top:2px;text-align:left}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(17,17,17,.6);backdrop-filter:blur(2px);z-index:100}
    .modal.open{display:grid}
    .dialog{width:min(1000px,92vw);background:#000;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .dialog-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#111;color:#eee}
    .dialog-title{font-weight:700;font-size:.95rem}
    .dialog-close{background:transparent;border:0;color:#ddd;font-size:18px;cursor:pointer}
    .dialog-body{aspect-ratio:16/9;background:#000}
    .dialog-body iframe{width:100%;height:100%;border:0}

    /* Light dialog (Login/MyPage) */
    .dialog.light{background:#fff;color:#111}
    .dialog.light .dialog-header{background:#f6f7fb;color:#111;border-bottom:1px solid var(--bd)}
    .dialog.light .dialog-body{aspect-ratio:auto;padding:0}

    /* Footer */
    footer{border-top:1px solid var(--bd);color:#777}
    footer .inner{padding:14px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}

    /* ===== Login Component (compiled) ===== */
    .login *{box-sizing:border-box}
    .login{display:grid;grid-template-columns:100%;height:100vh;margin:0 1.5rem}
    .login__content{display:grid}
    .login__img{justify-self:center}
    .login__img img{width:310px;margin-top:1.5rem}
    .login__forms{position:relative;height:368px}
    .login__register,.login__create{position:absolute;bottom:1rem;width:100%;background-color:var(--login-lighten);padding:2rem 1rem;border-radius:1rem;text-align:center;box-shadow:0 8px 20px rgba(35,0,77,.2);animation-duration:.4s;animation-name:animateLogin}
    .login__title{font-size:var(--login-big);margin-bottom:2rem;font-family:var(--login-font)}
    .login__box{display:grid;grid-template-columns:max-content 1fr;column-gap:.5rem;padding:1.125rem 1rem;background-color:#fff;margin-top:1rem;border-radius:.5rem}
    .login__icon{font-size:1.5rem;color:var(--login-color)}
    .login__input{border:none;outline:none;font-size:var(--login-normal);font-weight:700;color:var(--login-dark);width:100%;font-family:var(--login-font)}
    .login__input::placeholder{font-size:var(--login-normal);font-family:var(--login-font);color:var(--login-light)}
    .login__forgot{display:block;width:max-content;margin-left:auto;margin-top:.5rem;font-size:var(--login-small);font-weight:600;color:var(--login-light)}
    .login__button{display:block;padding:1rem;margin:2rem 0;background-color:var(--login-color);color:#fff;font-weight:600;text-align:center;border-radius:.5rem;transition:.3s}
    .login__button:hover{background-color:var(--login-hover)}
    .login__account,.login__signin,.login__signup{font-weight:600;font-size:var(--login-small)}
    .login__account--account{color:var(--login-dark)}
    .login__signin--signup,.login__signup--signup{color:var(--login-color);cursor:pointer}
    .login__social{margin-top:2rem}
    .login__social--icon{font-size:1.5rem;color:var(--login-dark);margin:0 1rem}
    .block{display:block}.none{display:none}
    @keyframes animateLogin{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    @media(min-width:576px){ .login__forms{width:348px;justify-self:center} }
    @media(min-width:1024px){
      .login{height:100vh;overflow:hidden}
      .login__content{grid-template-columns:repeat(2,max-content);justify-content:center;align-items:center;margin-left:10rem}
      .login__img{display:flex;width:600px;height:588px;background-color:#fff;border-radius:1rem;padding-left:1rem}
      .login__img img{width:80%;margin-top:0}
      .login__register,.login__create{left:-11rem}
      .login__register{bottom:-2rem}
      .login__create{bottom:-5.5rem}
    }

    /* ===== My Page (simple) ===== */
    .mypage{padding:18px}
    .mypage .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){ .mypage .row{grid-template-columns:1fr} }
    .mypage .card{border:1px solid var(--bd);border-radius:12px;padding:14px;background:#fff}
    .mypage h3{margin:0 0 8px 0}
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" id="brandHome" href="/"><div class="logo"></div> ÍµêÏú°Ïö© Î™®Îç∏ Ïπ¥ÌÉàÎ°úÍ∑∏</a>
      <div class="search">
        üîé<input id="q" placeholder="Î™®Îç∏/ÏÑ§Î™Ö Í≤ÄÏÉâ (Ïòà: ÏÑ∏Ìè¨, ÌôîÏÇ∞, DNA, Í¥ëÌïô)" />
        <button class="btn" id="btnSearch">Í≤ÄÏÉâ</button>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn primary" id="btnAuth" type="button">Î°úÍ∑∏Ïù∏</button>
        <button class="btn ghost" id="btnLogout" type="button" style="display:none;">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
    </div>
    <div class="filterbar">
      <div class="container filters">
        <div class="group" id="subjectGroup">
          <label><input type="checkbox" class="subject-chk" value="biology">ÏÉùÎ™ÖÍ≥ºÌïô</label>
          <label><input type="checkbox" class="subject-chk" value="earth">ÏßÄÍµ¨Í≥ºÌïô</label>
          <label><input type="checkbox" class="subject-chk" value="physics">Î¨ºÎ¶¨</label>
          <label><input type="checkbox" class="subject-chk" value="chemistry">ÌôîÌïô</label>
          <label><input type="checkbox" class="subject-chk" value="history">ÌïúÍµ≠ÏÇ¨</label>
          <label><input type="checkbox" class="subject-chk" value="geography">ÏßÄÎ¶¨</label>
        </div>
        <button class="btn clear" id="btnClear" type="button">Ï¥àÍ∏∞Ìôî</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="count" class="muted" style="margin-bottom:8px"></div>
    <div class="results" id="results"></div>
    <div class="pager" id="pager" style="text-align:center;margin-top:16px"></div>
  </main>

  <!-- Model Viewer Modal -->
  <div class="modal" id="modal" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="dialog">
      <div class="dialog-header">
        <div class="dialog-title" id="modalTitle">ÎØ∏Î¶¨Î≥¥Í∏∞</div>
        <button class="dialog-close" id="btnClose" type="button" aria-label="Îã´Í∏∞">‚úï</button>
      </div>
      <div class="dialog-body">
        <iframe id="viewer" allow="autoplay; fullscreen; xr-spatial-tracking"
          xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered
          web-share allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
      </div>
    </div>
  </div>

  <!-- Login Modal (Î©îÏù∏ÏóêÏÑúÎäî Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏ Ï∞®Îã®) -->
  <div class="modal" id="modalLogin" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="login">
      <div class="login__content">
        <div class="login__img">
          <img src="https://image.freepik.com/free-vector/code-typing-concept-illustration_114360-3581.jpg" alt="user login">
        </div>
        <div class="login__forms">
          <form action="#" class="login__register block" id="login-in">
            <h1 class="login__title">Sign In</h1>
            <div class="login__box">
              <i class='bx bx-user login__icon'></i>
              <input id="loginUsername" type="text" placeholder="Username" class="login__input" required>
            </div>
            <div class="login__box">
              <i class='bx bx-lock login__icon'></i>
              <input id="loginPw" type="password" placeholder="Password" class="login__input" required>
            </div>
            <button class="login__button" id="btnSignIn" type="submit">Sign In</button>
            <div>
              <span class="login__account login__account--account">Don't Have an Account?</span>
              <span class="login__signin login__signin--signup" id="sign-up">Sign Up</span>
            </div>
          </form>

          <form action="#" class="login__create none" id="login-up">
            <h1 class="login__title">Create Account</h1>
            <div class="login__box">
              <i class='bx bx-user login__icon'></i>
              <input id="signupUsername" type="text" placeholder="Username" class="login__input" required>
            </div>
            <div class="login__box">
              <i class='bx bx-at login__icon'></i>
              <input id="signupEmail" type="email" placeholder="Email (optional)" class="login__input">
            </div>
            <div class="login__box">
              <i class='bx bx-lock login__icon'></i>
              <input id="signupPw" type="password" placeholder="Password" class="login__input" required>
            </div>
            <button class="login__button" id="btnSignUp" type="submit">Sign Up</button>
            <div>
              <span class="login__account login__account--account">Already have an Account?</span>
              <span class="login__signup login__signup--signup" id="sign-in">Sign In</span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- My Page Modal (Í∞ÑÎã® Î≤ÑÏ†Ñ ‚Äî Î≤ÑÌäº Ï†ÑÌôòÏö©) -->
  <div class="modal" id="modalMypage" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="dialog light" style="width:min(720px,92vw);">
      <div class="dialog-header">
        <div class="dialog-title">ÎßàÏù¥ÌéòÏù¥ÏßÄ</div>
        <button class="dialog-close" id="btnCloseMypage" type="button" aria-label="Îã´Í∏∞">‚úï</button>
      </div>
      <div class="dialog-body">
        <div class="mypage">
          <div class="row">
            <div class="card">
              <h3>ÎÇ¥ Ï†ïÎ≥¥</h3>
              <div id="myUser">-</div>
            </div>
            <div class="card">
              <h3>Ï¶êÍ≤®Ï∞æÍ∏∞ (ÏòàÏ†ï)</h3>
              <div class="muted">Ï∂îÌõÑ Î∂ÅÎßàÌÅ¨/ÏµúÍ∑º Î≥∏ Ìï≠Î™© Îì±ÏùÑ Î≥¥Ïó¨Ï§Ñ ÏòàÏ†ïÏûÖÎãàÎã§.</div>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
            <button class="btn ghost" id="btnMypageLogout">Î°úÍ∑∏ÏïÑÏõÉ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" style="
  position:fixed; top:20px; left:50%; right:auto; z-index:9999;
  transform:translate(-50%, -12px); opacity:0;
  background:rgba(17,17,17,.9); color:#fff;
  padding:12px 16px; border-radius:10px;
  font-weight:700; font-size:.95rem; text-align:center;
  max-width:90vw; pointer-events:none;
  transition:opacity .25s, transform .25s;"></div>


  <footer>
    <div class="container inner">
      <div>¬© <span id="year"></span> Model Catalog</div>
      <div><a href="#" onclick="event.preventDefault()">Privacy</a> ¬∑ <a href="#" onclick="event.preventDefault()">Terms</a></div>
    </div>
  </footer>

  <!-- Fallback data -->
  <script type="application/json" id="models-json">[
    {"id":1,"title":"ÏÑ∏Ìè¨ Íµ¨Ï°∞ #1","description":"ÏÑ∏Ìè¨Ïùò Í∏∞Î≥∏ Íµ¨Ï°∞ÏôÄ ÏÜåÍ∏∞Í¥Ä Î∞∞ÏπòÎ•º ÏÇ¥Ìé¥Î≥º Ïàò ÏûàÎäî Î™®Îç∏","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/cell-1.png","subject":"biology"},
    {"id":2,"title":"ÏßÄÍµ¨ Îã®Î©¥ #2","description":"ÏßÄÍ∞Å‚ÄìÎß®ÌãÄ‚ÄìÌïµÏùò Ï∏µÏÉÅÏùÑ Îã®Î©¥ÏúºÎ°ú ÌëúÌòÑ","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/earth-2.png","subject":"earth"},
    {"id":3,"title":"ÏõêÏûê Î™®Îç∏ #3","description":"ÏõêÏûêÌïµÍ≥º Ï†ÑÏûêÍªçÏßàÏùò Í∞úÎÖêÏùÑ ÏãúÍ∞ÅÌôî","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/atom-3.png","subject":"chemistry"},
    {"id":4,"title":"Í¥ëÌïô Ïã§Ìóò #4","description":"Î†åÏ¶àÎ•º ÌÜµÌïú Íµ¥Ï†àÍ≥º ÏÉÅÏùò ÌòïÏÑ± ÏõêÎ¶¨","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/optics-4.png","subject":"physics"}
  </script>

  <script>
    /* ====== Utils ====== */
    const qs=s=>document.querySelector(s);
    const qsa=s=>[...document.querySelectorAll(s)];
    function showToast(msg, bg='#16a34a'){
  const t = document.getElementById('toast');
  if(!t) return;
  t.textContent = msg;
  t.style.background = bg;
  t.style.opacity = '1';
  t.style.transform = 'translate(-50%, 0)';    // Í∞ÄÏö¥Îç∞ÏóêÏÑú ÏïÑÎûòÎ°ú ÏÇ¥Ïßù
  clearTimeout(t._timer);
  t._timer = setTimeout(()=>{
    t.style.opacity = '0';
    t.style.transform = 'translate(-50%, -12px)'; // ÏúÑÎ°ú ÏÇ¨ÎùºÏßê
  }, 1800);
}
    function openLoginModal(){
      const mod = qs('#modalLogin');
      if(!mod) return;
      mod.classList.add('open');
      mod.focus();
      document.body.classList.add('no-scroll');
    }

    let MODELS = [];
    const SUBJECTS = {
      biology:{ label:'ÏÉùÎ™ÖÍ≥ºÌïô', keywords:['ÏÑ∏Ìè¨','DNA','ÏÉùÎ™Ö','ÏÉùÎ¨º','Ïú†Ï†Ñ','Îã®Î∞±Ïßà','Í¥ëÌï©ÏÑ±'] },
      earth:{ label:'ÏßÄÍµ¨Í≥ºÌïô', keywords:['ÏßÄÍµ¨','Îã®Î©¥','Ìåê Íµ¨Ï°∞','ÌôîÏÇ∞','ÏßÄÏßÑ','ÎåÄÍ∏∞','Í∏∞ÏÉÅ','ÏßÄÏßà'] },
      physics:{ label:'Î¨ºÎ¶¨', keywords:['Í¥ëÌïô','ÌååÎèô','Ï†ÑÍ∏∞','ÏûêÍ∏∞','Ïó≠Ìïô','Ïö¥Îèô','Î†åÏ¶à'] },
      chemistry:{ label:'ÌôîÌïô', keywords:['ÏõêÏûê','Î∂ÑÏûê','ÌôîÌï©Î¨º','Ïã§Ìóò','Í∏∞Íµ¨','Î∞òÏùë','Ï£ºÍ∏∞Ïú®'] },
      geography:{ label:'ÏßÄÎ¶¨', keywords:['ÏßÄÌòï','ÏÇºÍ∞ÅÏ£º','ÌòëÍ≥°','ÏßÄÎ¶¨','ÏßÄÎèÑ'] }
    };
    const state={q:"",page:1,per:12,sort:"relevance", subject:null, isLoggedIn:false, user:null, bookmarks:new Set()};

    // ---- ÏûêÎèô Ïç∏ÎÑ§Ïùº (Ï∫îÎ≤ÑÏä§) ----
    const THUMB_CACHE = new Map();
    function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
    function pickColors(key){
      const palette=[['#4e77ba','#bc2c3c'],['#3aa675','#0e7490'],['#7c3aed','#fb7185'],['#f59e0b','#ef4444'],['#2563eb','#16a34a'],['#9333ea','#3b82f6'],['#0ea5e9','#22c55e'],['#ef4444','#f97316']];
      const idx = hashCode(key) % palette.length; return palette[idx];
    }
    function genThumb(model){
      const key = String(model.id||model.title);
      if(THUMB_CACHE.has(key)) return THUMB_CACHE.get(key);
      const c=document.createElement('canvas'); c.width=640; c.height=480; const ctx=c.getContext('2d');
      const [c1,c2]=pickColors(key);
      const g=ctx.createLinearGradient(0,0,640,480); g.addColorStop(0,c1); g.addColorStop(1,c2);
      ctx.fillStyle=g; ctx.fillRect(0,0,640,480);
      ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='bold 32px Pretendard, system-ui'; ctx.textAlign='left'; ctx.textBaseline='top';
      const title=(model.title||'Untitled'); const words=title.split(/\s+/); let lines=[],cur='';
      for(const w of words){ const test=cur?cur+' '+w:w; if(ctx.measureText(test).width>560){ lines.push(cur); cur=w; } else { cur=test; } }
      if(cur) lines.push(cur); lines=lines.slice(0,3); let y=24; for(const ln of lines){ ctx.fillText(ln,24,y); y+=38; }
      ctx.font='16px Pretendard, system-ui'; const d=(model.description||''); const desc=d.length>60? d.slice(0,57)+'‚Ä¶': d; if(desc){ ctx.fillText(desc,24,y+6); }
      const url=c.toDataURL('image/png'); THUMB_CACHE.set(key,url); return url;
    }

    function toEmbed(url){
      try{
        const last=url.split('/').pop();
        const uid=(last||'').split('-').pop();
        return `https://sketchfab.com/models/${uid}/embed?ui_theme=dark`;
      }catch(e){return url;}
    }

    async function loadModels(){
      try{
        const res = await fetch('/api/models', { credentials: 'include' });
        if(res.ok){
          const data = await res.json();
          if(data && Array.isArray(data.items)){
            MODELS = data.items.map(m=>({
              id:m.id, title:m.title, description:m.description,
              url:m.url, subject:m.subject, thumb:m.thumb||null
            }));
            return;
          }
        }
      }catch(e){ console.warn('GET /api/models Ïã§Ìå®', e); }

      try{
        const res = await fetch('models.json', { cache:'no-store' });
        if(res.ok){ MODELS = await res.json(); if(Array.isArray(MODELS) && MODELS.length) return; }
      }catch(e){ console.warn('models.json Î°úÎìú Ïã§Ìå®', e); }

      try{
        const fallback = document.getElementById('models-json');
        if(fallback){ MODELS = JSON.parse(fallback.textContent || '[]'); }
      }catch(e){ console.warn('inline JSON ÌååÏã± Ïã§Ìå®', e); MODELS = []; }
    }

    function openModal(title,url){
      const modal=qs('#modal');
      const iframe=qs('#viewer');
      qs('#modalTitle').textContent=title||'ÎØ∏Î¶¨Î≥¥Í∏∞';
      iframe.src=toEmbed(url);
      modal.classList.add('open');
      modal.focus();
      document.body.classList.add('no-scroll');
    }
    function closeModal(){
      const modal=qs('#modal');
      const iframe=qs('#viewer');
      modal.classList.remove('open');
      document.body.classList.remove('no-scroll');
      iframe.src='';
    }

    function matchSubject(m, key){
      if(m.subject && m.subject===key) return true;
      const text = (m.title + ' ' + (m.description||'')).toLowerCase();
      const kw = SUBJECTS[key].keywords;
      return kw.some(k=> text.includes(k.toLowerCase()));
    }

    function isBookmarked(id){ return state.bookmarks.has(Number(id)); }

    function cardHTML(m){
      const src = m.thumb || genThumb(m);
      const bg = src ? ` style="background-image:url('${String(src).replace(/'/g,"%27")}')"` : '';
      const label = src ? '' : `Ïç∏ÎÑ§Ïùº ${m.id}`;
      const bmActive = isBookmarked(m.id);
      return `
      <article class="item" data-id="${m.id}">
        <div class="thumb" data-id="${m.id}" data-title="${m.title}" data-url="${m.url}"${bg}>
          ${label}
          <button class="bookmark-btn${bmActive?' active':''}" type="button" title="Î∂ÅÎßàÌÅ¨" aria-label="Î∂ÅÎßàÌÅ¨" data-bookmark="${bmActive?'1':'0'}" style="display:none;">
            <i class='bx ${bmActive?'bxs-bookmark':'bx-bookmark'}'></i>
          </button>
          <button class="thumb-del" type="button" title="ÏÇ≠Ï†ú" aria-label="ÏÇ≠Ï†ú">√ó</button>
        </div>
        <div class="meta">
          <div class="title">${m.title}</div>
          <div class="sub">${m.description||""}</div>
        </div>
      </article>`;
    }

    function render(){
      let list=MODELS
        .filter(m=>!state.q || (m.title + (m.description||'')).toLowerCase().includes(state.q.toLowerCase()))
        .filter(m=>!state.subject || matchSubject(m, state.subject));

      const total=list.length; const pages=Math.max(1,Math.ceil(total/state.per));
      state.page=Math.min(state.page,pages);
      const start=(state.page-1)*state.per; const pageItems=list.slice(start,start+state.per);

      qs('#count').textContent=`${total}Í∞ú Í≤∞Í≥º`;
      qs('#results').innerHTML=pageItems.map(cardHTML).join('');

      // Ïç∏ÎÑ§Ïùº ÌÅ¥Î¶≠ ‚Üí ÎØ∏Î¶¨Î≥¥Í∏∞ (‚òÖ Î∂ÅÎßàÌÅ¨ Î≤ÑÌäº ÌÅ¥Î¶≠ÏùÄ Î¨¥Ïãú)
      qsa('.thumb').forEach(el=>el.addEventListener('click',(e)=>{
        if(e.target.closest('.bookmark-btn')) return; // Í∞ÄÎìú
        openModal(el.dataset.title,el.dataset.url);
      }));

      // (Î©îÏù∏ÌéòÏù¥ÏßÄ) ÏÇ≠Ï†ú Î≤ÑÌäº Î¨¥Î†•Ìôî
      qsa('.thumb-del').forEach(btn=>{
        btn.style.display = 'none';
        btn.onclick = e => { e.stopPropagation(); return false; };
      });

      // ‚òÖ Î∂ÅÎßàÌÅ¨ Î≤ÑÌäº Î≥¥Ïù¥Í∏∞/ÎèôÏûë(Î°úÍ∑∏Ïù∏ÏãúÏóêÎßå)
      qsa('.bookmark-btn').forEach(btn=>{
        if(state.isLoggedIn){
          btn.style.display = 'inline-grid';
        }else{
          btn.style.display = 'none';
        }
        btn.addEventListener('click', async (e)=>{
          e.stopPropagation();   // Ï†ÑÌåå Ï∞®Îã®
          e.preventDefault();    // Í∏∞Î≥∏ ÎèôÏûë Ï∞®Îã®

          const card = btn.closest('.item');
          const id = Number(card?.dataset?.id);
          if(!id) return;

          if(isBookmarked(id)){
            try{
              const res = await fetch(`/api/bookmarks/${id}`, { method:'DELETE', credentials:'include' });
              if(res.status===401){ openLoginModal(); return; }
              if(!res.ok){ throw new Error('BOOKMARK_DELETE_FAILED'); }
              state.bookmarks.delete(id);
              btn.classList.remove('active');
              btn.dataset.bookmark='0';
              btn.querySelector('i').className='bx bx-bookmark';
              showToast('Î∂ÅÎßàÌÅ¨ÏóêÏÑú Ï†úÍ±∞Îê® ‚ùå', '#e63946');
            }catch(err){
              alert('Î∂ÅÎßàÌÅ¨ Ìï¥Ï†ú Ïã§Ìå®: ' + (err.message||'UNKNOWN'));
            }
          }else{
            try{
              const res = await fetch('/api/bookmarks', {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                credentials:'include',
                body: JSON.stringify({ modelId: id })
              });
              if(res.status===401){ openLoginModal(); return; }
              if(!res.ok){ throw new Error('BOOKMARK_POST_FAILED'); }
              state.bookmarks.add(id);
              btn.classList.add('active');
              btn.dataset.bookmark='1';
              btn.querySelector('i').className='bx bxs-bookmark';
              showToast('Î∂ÅÎßàÌÅ¨Ïóê Ï∂îÍ∞ÄÎê® ‚úÖ');
            }catch(err){
              alert('Î∂ÅÎßàÌÅ¨ Ïã§Ìå®: ' + (err.message||'UNKNOWN'));
            }
          }
        });
      });

      // ÌéòÏù¥Ï†Ä
      const pager = qs('#pager');
      pager.innerHTML=Array.from({length:pages})
        .map((_,i)=>`<button ${i+1===state.page?'class="btn primary"':'class="btn"'} data-page="${i+1}">${i+1}</button>`)
        .join('');
      qsa('#pager [data-page]').forEach(b=>b.addEventListener('click',()=>{state.page=+b.dataset.page;render()}));
    }

    // Í≤ÄÏÉâ
    qs('#btnSearch').addEventListener('click',()=>{state.q=qs('#q').value.trim();state.page=1;render();});
    qs('#q').addEventListener('keydown',e=>{if(e.key==='Enter'){state.q=qs('#q').value.trim();state.page=1;render();}});

    // Í≥ºÎ™© Îã®Ïùº ÏÑ†ÌÉù
    qsa('.subject-chk').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        if(chk.checked){
          qsa('.subject-chk').forEach(other=>{ if(other!==chk) other.checked=false; });
          state.subject = chk.value;
        }else{
          state.subject = null;
        }
        state.page=1; render();
      });
    });
    qs('#btnClear').addEventListener('click', ()=>{
      qsa('.subject-chk').forEach(c=>c.checked=false);
      state.subject=null; state.page=1; render();
    });

    // Î∑∞Ïñ¥ Î™®Îã¨ Îã´Í∏∞
    qs('#btnClose').addEventListener('click', closeModal);
    qs('#modal').addEventListener('click', e=>{ if(e.target === e.currentTarget) closeModal(); });
    document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeModal(); }, true);

    // ===== Login UI interactions =====
    const signup = document.getElementById("sign-up");
    const signin = document.getElementById("sign-in");
    const loginin = document.getElementById("login-in");
    const loginup = document.getElementById("login-up");
    signup && signup.addEventListener("click", () => {
      loginin.classList.remove("block"); loginup.classList.remove("none");
      loginin.classList.add("none");     loginup.classList.add("block");
    });
    signin && signin.addEventListener("click", () => {
      loginin.classList.remove("none");  loginup.classList.remove("block");
      loginin.classList.add("block");    loginup.classList.add("none");
    });

    // API ÎûòÌçº
    async function api(path, method='GET', body){
      const res = await fetch(path, {
        method,
        headers: body instanceof FormData ? undefined : { 'Content-Type':'application/json' },
        credentials: 'include',
        body: body ? (body instanceof FormData ? body : JSON.stringify(body)) : undefined
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw Object.assign(new Error(data.error||'ÏöîÏ≤≠ Ïã§Ìå®'), { status: res.status, data });
      return data;
    }

    // ‚òÖ ÎÇ¥ Î∂ÅÎßàÌÅ¨ Î∂àÎü¨Ïò§Í∏∞
    async function loadMyBookmarks(){
      state.bookmarks.clear();
      try{
        // ÌôïÏû• ÏùëÎãµ(Í∞ùÏ≤¥ Î∞∞Ïó¥)ÏùÑ ÏõêÌïòÎ©¥ ?expand=1 ÏÇ¨Ïö© Í∞ÄÎä•. Ïó¨Í∏∞ÏÑúÎäî id ÏÑ∏Ìä∏Îßå Ïç®ÎèÑ Ï∂©Î∂Ñ
        const res = await fetch('/api/bookmarks', { credentials:'include' });
        if(!res.ok) return;
        const data = await res.json().catch(()=>({}));
        const ids = Array.isArray(data?.items) ? data.items
                 : Array.isArray(data) ? data
                 : [];
        ids.forEach(id=> state.bookmarks.add(Number(id)));
      }catch(e){
        console.warn('loadMyBookmarks fail', e);
      }
    }

    async function refreshAuthUI(){
      try{
        const me = await api('/api/auth/whoami');
        // Î©îÏù∏ÏóêÏÑúÎäî 'admin'ÏùÑ Î°úÍ∑∏Ïù∏ÏúºÎ°ú Ï∑®Í∏âÌïòÏßÄ ÏïäÏùå
        if(me && me.user && me.user.role !== 'admin'){
          state.isLoggedIn = true;
          state.user = me.user;
          await loadMyBookmarks();
        }else{
          state.isLoggedIn = false;
          state.user = null;
          state.bookmarks.clear();
        }
      }catch{
        state.isLoggedIn = false; state.user = null; state.bookmarks.clear();
      }

      const btnAuth = document.getElementById('btnAuth');
      const btnLogout = document.getElementById('btnLogout');

      if(state.isLoggedIn){
        btnAuth.textContent = 'ÎßàÏù¥ÌéòÏù¥ÏßÄ';
        btnLogout.style.display = 'inline-flex';
      }else{
        btnAuth.textContent = 'Î°úÍ∑∏Ïù∏';
        btnLogout.style.display = 'none';
      }
      render(); // ÏÉÅÌÉú Î∞òÏòÅ(Î∂ÅÎßàÌÅ¨ ÏïÑÏù¥ÏΩòÎèÑ Î∞òÏòÅ)
    }

    // Î°úÍ∑∏Ïù∏/ÎßàÏù¥ÌéòÏù¥ÏßÄ Ïù¥Îèô
    document.getElementById('btnAuth').addEventListener('click', (e)=>{
      e.preventDefault();
      if(state.isLoggedIn){
        window.location.href = '/mypage.html';
      }else{
        openLoginModal();
      }
    });

    // Î°úÍ∑∏ÏïÑÏõÉ (Ìó§Îçî)
    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      try{ await api('/api/auth/logout','POST'); }catch(e){ console.warn('logout error', e); }
      state.isLoggedIn = false; state.user = null; state.bookmarks.clear();
      ['#modalLogin','#modalMypage','#modal'].forEach(sel=>qs(sel)?.classList.remove('open'));
      document.body.classList.remove('no-scroll');
      await refreshAuthUI();
    });

    // ÎßàÏù¥ÌéòÏù¥ÏßÄ ÏïàÏùò Î°úÍ∑∏ÏïÑÏõÉ
    document.getElementById('btnMypageLogout').addEventListener('click', async ()=>{
      try{ await api('/api/auth/logout','POST'); }catch{}
      state.isLoggedIn = false; state.user = null; state.bookmarks.clear();
      qs('#modalMypage').classList.remove('open'); document.body.classList.remove('no-scroll');
      await refreshAuthUI();
    });
    // ÎßàÏù¥ÌéòÏù¥ÏßÄ Îã´Í∏∞
    document.getElementById('btnCloseMypage').addEventListener('click', ()=>{
      qs('#modalMypage').classList.remove('open'); document.body.classList.remove('no-scroll');
    });
    qs('#modalMypage').addEventListener('click', e=>{ if(e.target === e.currentTarget){ qs('#modalMypage').classList.remove('open'); document.body.classList.remove('no-scroll'); } });

    // Sign In (Î©îÏù∏: Í¥ÄÎ¶¨Ïûê Ï∞®Îã®)
    document.getElementById('login-in').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = (document.getElementById('loginUsername').value||'').trim();
      const pw = (document.getElementById('loginPw').value||'').trim();
      try{
        await api('/api/auth/login','POST',{ username, password: pw });
        try{
          const me = await api('/api/auth/whoami');
          if(me?.user?.role === 'admin'){
            await api('/api/auth/logout','POST');
            return;
          }
        }catch{}
        await refreshAuthUI();
        const m=qs('#modalLogin'); m.classList.remove('open'); document.body.classList.remove('no-scroll');
      }catch(err){ alert(err.data?.error || 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®'); }
    });

    // Sign Up
    document.getElementById('login-up')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('signupUsername')?.value?.trim();
      const email = document.getElementById('signupEmail')?.value?.trim();
      const pw = document.getElementById('signupPw')?.value?.trim();
      if(!username || !pw){ alert('Username/PasswordÎäî ÌïÑÏàòÏûÖÎãàÎã§.'); return; }
      if(username.toLowerCase() === 'admin'){
        alert('Ïù¥ ÏÇ¨Ïö©ÏûêÎ™ÖÏùÄ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
      }
      try{
        await api('/api/auth/signup','POST',{ username, email, password: pw });
        (document.getElementById('sign-in')||{}).click?.();
        alert('Í∞ÄÏûÖ ÏôÑÎ£å! Ïù¥Ï†ú Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.');
      }catch(err){ alert(err.data?.error || 'Í∞ÄÏûÖ Ïã§Ìå®'); }
    });

    // ÏãúÏûë
    document.getElementById('year').textContent=new Date().getFullYear();
    (async()=>{ await refreshAuthUI(); await loadModels(); render(); })();
  </script>
</body>
</html>
