<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>교육용 모델 카탈로그</title>
  <meta name="description" content="파일(models.json) 또는 /api/models 기반 교육용 모델 카탈로그. 과목 필터 + 로그인/로그아웃 + 업로드 + 삭제(로그인 시) + Sketchfab 임베드 팝업." />
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>

  <style>
    :root {
      --c1:#bc2c3c; --c2:#4e77ba; --bg:#f7f7f8; --card:#fff; --text:#111; --muted:#666; --bd:#e6e6e8;
      --ring:#4e77ba; --danger:#e63946; --ok:#16a34a; --shadow:0 10px 30px rgba(0,0,0,.12); --radius:16px;
      --login-color:#4AD395;--login-dark:#23004d;--login-light:#a49eac;--login-lighten:#f2f2f2;--login-hover:#65bf97;
      --login-font:"Open Sans", sans-serif;--login-big:1.5rem;--login-normal:0.938rem;--login-small:0.813rem;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font:14px/1.6 Pretendard,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR;color:var(--text);background:var(--bg)}
    .no-scroll{overflow:hidden}
    .container{max-width:1280px;margin:0 auto;padding:0 16px}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--bd)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px;gap:12px}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:800}
    .logo{width:28px;height:28px;border-radius:9px;background:linear-gradient(135deg,var(--c1),var(--c2))}
    .search{flex:1;display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--bd);border-radius:14px;padding:8px 10px;margin:0 16px}
    .search input{border:0;outline:0;flex:1;font:inherit}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--bd);background:#fff;border-radius:12px;padding:8px 12px;text-decoration:none;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,var(--c1),var(--c2));border:none;color:#fff;box-shadow:var(--shadow)}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:#333}

    /* Filter Bar */
    .filterbar{background:#fff;border-top:1px solid var(--bd);border-bottom:1px solid var(--bd)}
    .filters{display:flex;align-items:center;flex-wrap:wrap;gap:12px;padding:10px 0}
    .filters .group{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .filters input[type="checkbox"]{width:16px;height:16px}
    .filters label{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;cursor:pointer;user-select:none}
    .filters .clear{margin-left:auto}

    /* Layout */
    main{padding:16px 0}
    .results{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}
    @media(max-width:1200px){.results{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.results{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.results{grid-template-columns:1fr}}

    .item{display:flex;flex-direction:column;overflow:hidden;background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);position:relative}
    .thumb{
      aspect-ratio:1.2/1;background:#e9e9ee;display:grid;place-items:center;color:#888;
      border-bottom:1px solid var(--bd);cursor:pointer;position:relative;background-size:cover;background-position:center;background-repeat:no-repeat
    }
    /* 안내 배지는 뒤로 */
    .thumb::after{
      content:"클릭하여 미리보기";position:absolute;bottom:8px;right:8px;background:rgba(17,17,17,.75);
      color:#fff;font-size:.75rem;padding:4px 8px;border-radius:8px;z-index:1;pointer-events:none;
    }
    /* 썸네일 내 X 삭제 버튼(로그인 시에만 표시) */
    .thumb-del{
      position:absolute;top:8px;right:8px;z-index:2;
      width:28px;height:28px;border-radius:50%;
      display:inline-grid;place-items:center;
      background:rgba(255,255,255,.95);border:1px solid var(--bd);
      cursor:pointer;box-shadow:var(--shadow);font-weight:800;line-height:1;
    }
    .thumb-del:hover{filter:brightness(.96)}
    .meta{padding:10px;text-align:left}
    .title{font-weight:700;text-align:left}
    .sub{color:var(--muted);font-size:.85rem;margin-top:2px;text-align:left}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(17,17,17,.6);backdrop-filter:blur(2px);z-index:100}
    .modal.open{display:grid}
    .dialog{width:min(1000px,92vw);background:#000;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .dialog-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#111;color:#eee}
    .dialog-title{font-weight:700;font-size:.95rem}
    .dialog-close{background:transparent;border:0;color:#ddd;font-size:18px;cursor:pointer}
    .dialog-body{aspect-ratio:16/9;background:#000}
    .dialog-body iframe{width:100%;height:100%;border:0}

    /* Light dialog (Upload/Login) */
    .dialog.light{background:#fff;color:#111}
    .dialog.light .dialog-header{background:#f6f7fb;color:#111;border-bottom:1px solid var(--bd)}
    .dialog.light .dialog-body{aspect-ratio:auto;padding:0}

    /* Footer */
    footer{border-top:1px solid var(--bd);color:#777}
    footer .inner{padding:14px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}

    /* ===== Login Component (compiled) ===== */
    .login *{box-sizing:border-box}
    .login{display:grid;grid-template-columns:100%;height:100vh;margin:0 1.5rem}
    .login__content{display:grid}
    .login__img{justify-self:center}
    .login__img img{width:310px;margin-top:1.5rem}
    .login__forms{position:relative;height:368px}
    .login__register,.login__create{position:absolute;bottom:1rem;width:100%;background-color:var(--login-lighten);padding:2rem 1rem;border-radius:1rem;text-align:center;box-shadow:0 8px 20px rgba(35,0,77,.2);animation-duration:.4s;animation-name:animateLogin}
    .login__title{font-size:var(--login-big);margin-bottom:2rem;font-family:var(--login-font)}
    .login__box{display:grid;grid-template-columns:max-content 1fr;column-gap:.5rem;padding:1.125rem 1rem;background-color:#fff;margin-top:1rem;border-radius:.5rem}
    .login__icon{font-size:1.5rem;color:var(--login-color)}
    .login__input{border:none;outline:none;font-size:var(--login-normal);font-weight:700;color:var(--login-dark);width:100%;font-family:var(--login-font)}
    .login__input::placeholder{font-size:var(--login-normal);font-family:var(--login-font);color:var(--login-light)}
    .login__forgot{display:block;width:max-content;margin-left:auto;margin-top:.5rem;font-size:var(--login-small);font-weight:600;color:var(--login-light)}
    .login__button{display:block;padding:1rem;margin:2rem 0;background-color:var(--login-color);color:#fff;font-weight:600;text-align:center;border-radius:.5rem;transition:.3s}
    .login__button:hover{background-color:var(--login-hover)}
    .login__account,.login__signin,.login__signup{font-weight:600;font-size:var(--login-small)}
    .login__account--account{color:var(--login-dark)}
    .login__signin--signup,.login__signup--signup{color:var(--login-color);cursor:pointer}
    .login__social{margin-top:2rem}
    .login__social--icon{font-size:1.5rem;color:var(--login-dark);margin:0 1rem}
    .block{display:block}.none{display:none}
    @keyframes animateLogin{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    @media(min-width:576px){ .login__forms{width:348px;justify-self:center} }
    @media(min-width:1024px){
      .login{height:100vh;overflow:hidden}
      .login__content{grid-template-columns:repeat(2,max-content);justify-content:center;align-items:center;margin-left:10rem}
      .login__img{display:flex;width:600px;height:588px;background-color:#fff;border-radius:1rem;padding-left:1rem}
      .login__img img{width:80%;margin-top:0}
      .login__register,.login__create{left:-11rem}
      .login__register{bottom:-2rem}
      .login__create{bottom:-5.5rem}
    }

    /* ======= Upload Form (Pretty) ======= */
    .upload-sheet{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;padding:18px;}
    @media(max-width:900px){ .upload-sheet{grid-template-columns:1fr;gap:14px} }
    .u-card{background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:var(--shadow)}
    .u-section{padding:16px 16px 2px;border-bottom:1px solid var(--bd);font-weight:700}
    .u-body{padding:16px}
    .field{display:grid;gap:6px;margin-bottom:14px}
    .label{font-size:.92rem;color:#333}
    .control{position:relative}
    .control input[type="text"], .control input[type="url"], .control textarea, .control select{
      width:100%;border:1px solid var(--bd);border-radius:12px;padding:12px 14px;font:inherit;background:#fff;outline:none;transition:border .15s, box-shadow .15s;
    }
    .control textarea{min-height:110px;resize:vertical}
    .control:focus-within input, .control:focus-within textarea, .control:focus-within select{border-color:var(--ring);box-shadow:0 0 0 3px rgba(78,119,186,.15)}
    .hint{font-size:.8rem;color:#777}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){ .row{grid-template-columns:1fr} }
    .drop{display:grid;place-items:center;border:1.5px dashed #cfd3e1;border-radius:14px;padding:18px;background:linear-gradient(180deg,#fafbff, #fff);
      text-align:center;cursor:pointer;transition:.15s;min-height:150px;position:relative;overflow:hidden;}
    .drop:hover{border-color:var(--ring);box-shadow:0 0 0 3px rgba(78,119,186,.12)}
    .drop input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .drop .icon{font-size:34px;margin-bottom:6px;opacity:.85}
    .drop .title{font-weight:700}
    .drop .sub{font-size:.85rem;color:#666}
    .drop.drag{border-color:var(--c2);box-shadow:0 0 0 4px rgba(78,119,186,.18)}
    .preview{margin-top:10px;border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#fff;display:flex;gap:10px;align-items:center;padding:8px;}
    .preview img{width:72px;height:72px;object-fit:cover;border-radius:10px;background:#f2f3f7}
    .preview .meta{font-size:.85rem;color:#555}
    .preview .meta .name{font-weight:700;color:#333}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}

    /* ===== Drag & Drop Visuals ===== */
    .item[draggable="true"]{cursor:grab}
    .item.dragging{opacity:.6;transform:scale(.98)}
    .item.drag-over-before{outline:2px dashed var(--ring); outline-offset:-8px}
    .item.drag-over-after{outline:2px dashed var(--ring); outline-offset:-8px}
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand"><div class="logo"></div> 교육용 모델 카탈로그</div>
      <div class="search">
        🔎<input id="q" placeholder="모델/설명 검색 (예: 세포, 화산, DNA, 광학)" />
        <button class="btn" id="btnSearch">검색</button>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn primary" id="btnAuth" type="button">로그인</button>
        <button class="btn ghost" id="btnLogout" type="button" style="display:none;">로그아웃</button>
      </div>
    </div>
    <div class="filterbar">
      <div class="container filters">
        <div class="group" id="subjectGroup">
          <label><input type="checkbox" class="subject-chk" value="biology">생명과학</label>
          <label><input type="checkbox" class="subject-chk" value="earth">지구과학</label>
          <label><input type="checkbox" class="subject-chk" value="physics">물리</label>
          <label><input type="checkbox" class="subject-chk" value="chemistry">화학</label>
          <label><input type="checkbox" class="subject-chk" value="history">한국사</label>
          <label><input type="checkbox" class="subject-chk" value="geography">지리</label>
        </div>
        <button class="btn clear" id="btnClear" type="button">초기화</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="count" class="muted" style="margin-bottom:8px"></div>
    <div class="results" id="results"></div>
    <div class="pager" id="pager" style="text-align:center;margin-top:16px"></div>
  </main>

  <!-- Model Viewer Modal -->
  <div class="modal" id="modal" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="dialog">
      <div class="dialog-header">
        <div class="dialog-title" id="modalTitle">미리보기</div>
        <button class="dialog-close" id="btnClose" type="button" aria-label="닫기">✕</button>
      </div>
      <div class="dialog-body">
        <iframe id="viewer" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="modalLogin" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="login">
      <div class="login__content">
        <div class="login__img">
          <img src="https://image.freepik.com/free-vector/code-typing-concept-illustration_114360-3581.jpg" alt="user login">
        </div>
        <div class="login__forms">
          <form action="#" class="login__register block" id="login-in">
            <h1 class="login__title">Sign In</h1>
            <div class="login__box">
              <i class='bx bx-user login__icon'></i>
              <input id="loginUsername" type="text" placeholder="Username" class="login__input" required>
            </div>
            <div class="login__box">
              <i class='bx bx-lock login__icon'></i>
              <input id="loginPw" type="password" placeholder="Password" class="login__input" required>
            </div>
            <a href="#" class="login__forgot">Forgot Password?</a>
            <button class="login__button" id="btnSignIn" type="submit">Sign In</button>
            <div>
              <span class="login__account login__account--account">Don't Have an Account?</span>
              <span class="login__signin login__signin--signup" id="sign-up">Sign Up</span>
            </div>
          </form>

          <form action="#" class="login__create none" id="login-up">
            <h1 class="login__title">Create Account</h1>
            <div class="login__box">
              <i class='bx bx-user login__icon'></i>
              <input id="signupUsername" type="text" placeholder="Username" class="login__input" required>
            </div>
            <div class="login__box">
              <i class='bx bx-at login__icon'></i>
              <input id="signupEmail" type="email" placeholder="Email (optional)" class="login__input">
            </div>
            <div class="login__box">
              <i class='bx bx-lock login__icon'></i>
              <input id="signupPw" type="password" placeholder="Password" class="login__input" required>
            </div>
            <button class="login__button" id="btnSignUp" type="submit">Sign Up</button>
            <div>
              <span class="login__account login__account--account">Already have an Account?</span>
              <span class="login__signup login__signup--signup" id="sign-in">Sign In</span>
            </div>
            <div class="login__social">
              <i class='bx bxl-facebook login__social--icon'></i>
              <i class='bx bxl-twitter login__social--icon'></i>
              <i class='bx bxl-google login__social--icon'></i>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal" id="modalUpload" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="dialog light" style="width:min(900px,92vw);">
      <div class="dialog-header">
        <div class="dialog-title">모델 업로드</div>
        <button class="dialog-close" id="btnCloseUpload" type="button" aria-label="닫기">✕</button>
      </div>

      <div class="dialog-body">
        <div class="upload-sheet">
          <!-- Left: form fields -->
          <div class="u-card">
            <div class="u-section">기본 정보</div>
            <div class="u-body">
              <form id="uploadForm" class="form">
                <div class="field">
                  <label class="label">제목 <span class="hint">(*필수)</span></label>
                  <div class="control"><input id="uTitle" type="text" placeholder="예: 세포 구조 #1" required></div>
                </div>

                <div class="field">
                  <label class="label">설명 <span class="hint">(*필수)</span></label>
                  <div class="control"><textarea id="uDesc" placeholder="모델의 주요 학습 포인트를 적어주세요." required></textarea></div>
                </div>

                <div class="row">
                  <div class="field">
                    <label class="label">Sketchfab URL <span class="hint">(*필수)</span></label>
                    <div class="control"><input id="uUrl" type="url" placeholder="https://sketchfab.com/3d-models/..." required></div>
                    <div class="hint">URL에서 마지막 slug만으로도 자동 임베드 됩니다.</div>
                  </div>

                  <div class="field">
                    <label class="label">과목</label>
                    <div class="control">
                      <select id="uSubject">
                        <option value="">선택 안 함</option>
                        <option value="biology">생명과학</option>
                        <option value="earth">지구과학</option>
                        <option value="physics">물리</option>
                        <option value="chemistry">화학</option>
                        <option value="history">한국사</option>
                        <option value="geography">지리</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn" type="button" id="btnResetUpload">초기화</button>
                  <button class="btn primary" type="submit">추가</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Right: thumbnail dropzone & preview -->
          <div class="u-card">
            <div class="u-section">썸네일</div>
            <div class="u-body">
              <label class="drop" id="dropArea">
                <input id="uThumb" type="file" accept="image/*">
                <div>
                  <div class="icon">🖼️</div>
                  <div class="title">이미지 드래그&드롭 또는 클릭하여 선택</div>
                  <div class="sub">PNG/JPG 권장 · 미선택 시 자동 생성 썸네일 사용</div>
                </div>
              </label>

              <div class="preview" id="thumbPreview" style="display:none;">
                <img id="thumbPreviewImg" alt="미리보기">
                <div class="meta">
                  <div class="name" id="thumbName">image.png</div>
                  <div class="hint" id="thumbSize">-</div>
                </div>
              </div>

            </div>
          </div>
        </div> <!-- /upload-sheet -->
      </div>
    </div>
  </div>

  <footer>
    <div class="container inner">
      <div>© <span id="year"></span> Model Catalog</div>
      <div><a href="#" onclick="event.preventDefault()">Privacy</a> · <a href="#" onclick="event.preventDefault()">Terms</a></div>
    </div>
  </footer>

  <!-- Fallback data -->
  <script type="application/json" id="models-json">[
    {"id":1,"title":"세포 구조 #1","description":"세포의 기본 구조와 소기관 배치를 살펴볼 수 있는 모델","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/cell-1.png","subject":"biology"},
    {"id":2,"title":"지구 단면 #2","description":"지각–맨틀–핵의 층상을 단면으로 표현","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/earth-2.png","subject":"earth"},
    {"id":3,"title":"원자 모델 #3","description":"원자핵과 전자껍질의 개념을 시각화","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/atom-3.png","subject":"chemistry"},
    {"id":4,"title":"광학 실험 #4","description":"렌즈를 통한 굴절과 상의 형성 원리","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/optics-4.png","subject":"physics"}
  </script>

  <script>
    let MODELS = [];
    async function loadModels(){
      try{
        const res = await fetch('/api/models', { credentials: 'include' });
        if(res.ok){
          const data = await res.json();
          if(data && Array.isArray(data.items)){
            MODELS = data.items.map(m=>({
              id:m.id, title:m.title, description:m.description,
              url:m.url, subject:m.subject, thumb:m.thumb||null
            }));
            return;
          }
        }
      }catch(e){ console.warn('GET /api/models 실패', e); }

      try{
        const res = await fetch('models.json', { cache:'no-store' });
        if(res.ok){ MODELS = await res.json(); if(Array.isArray(MODELS) && MODELS.length) return; }
      }catch(e){ console.warn('models.json 로드 실패', e); }

      try{
        const fallback = document.getElementById('models-json');
        if(fallback){ MODELS = JSON.parse(fallback.textContent || '[]'); }
      }catch(e){ console.warn('inline JSON 파싱 실패', e); MODELS = []; }
    }

    const SUBJECTS = {
      biology:{ label:'생명과학', keywords:['세포','DNA','생명','생물','유전','단백질','광합성'] },
      earth:{ label:'지구과학', keywords:['지구','단면','판 구조','화산','지진','대기','기상','지질'] },
      physics:{ label:'물리', keywords:['광학','파동','전기','자기','역학','운동','렌즈'] },
      chemistry:{ label:'화학', keywords:['원자','분자','화합물','실험','기구','반응','주기율'] },
      geography:{ label:'지리', keywords:['지형','삼각주','협곡','지리','지도'] }
    };

    const qs=s=>document.querySelector(s);
    const qsa=s=>[...document.querySelectorAll(s)];
    const state={q:"",page:1,per:12,sort:"relevance", subject:null, isLoggedIn:false};

    // ---- 자동 썸네일
    const THUMB_CACHE = new Map();
    function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
    function pickColors(key){
      const palette=[['#4e77ba','#bc2c3c'],['#3aa675','#0e7490'],['#7c3aed','#fb7185'],['#f59e0b','#ef4444'],['#2563eb','#16a34a'],['#9333ea','#3b82f6'],['#0ea5e9','#22c55e'],['#ef4444','#f97316']];
      const idx = hashCode(key) % palette.length; return palette[idx];
    }
    function genThumb(model){
      const key = String(model.id||model.title);
      if(THUMB_CACHE.has(key)) return THUMB_CACHE.get(key);
      const c=document.createElement('canvas'); c.width=640; c.height=480; const ctx=c.getContext('2d');
      const [c1,c2]=pickColors(key);
      const g=ctx.createLinearGradient(0,0,640,480); g.addColorStop(0,c1); g.addColorStop(1,c2);
      ctx.fillStyle=g; ctx.fillRect(0,0,640,480);
      ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='bold 32px Pretendard, system-ui'; ctx.textAlign='left'; ctx.textBaseline='top';
      const title=(model.title||'Untitled'); const words=title.split(/\s+/); let lines=[],cur='';
      for(const w of words){ const test=cur?cur+' '+w:w; if(ctx.measureText(test).width>560){ lines.push(cur); cur=w; } else { cur=test; } }
      if(cur) lines.push(cur); lines=lines.slice(0,3); let y=24; for(const ln of lines){ ctx.fillText(ln,24,y); y+=38; }
      ctx.font='16px Pretendard, system-ui'; const d=(model.description||''); const desc=d.length>60? d.slice(0,57)+'…': d; if(desc){ ctx.fillText(desc,24,y+6); }
      const url=c.toDataURL('image/png'); THUMB_CACHE.set(key,url); return url;
    }

    function toEmbed(url){
      try{
        const last=url.split('/').pop();
        const uid=(last||'').split('-').pop();
        return `https://sketchfab.com/models/${uid}/embed?ui_theme=dark`;
      }catch(e){return url;}
    }

    function openModal(title,url){
      const modal=qs('#modal');
      const iframe=qs('#viewer');
      qs('#modalTitle').textContent=title||'미리보기';
      iframe.src=toEmbed(url);
      modal.classList.add('open');
      modal.focus();
      document.body.classList.add('no-scroll');
    }
    function closeModal(){
      const modal=qs('#modal');
      const iframe=qs('#viewer');
      modal.classList.remove('open');
      document.body.classList.remove('no-scroll');
      iframe.src='';
    }

    function matchSubject(m, key){
      if(m.subject && m.subject===key) return true;
      const text = (m.title + ' ' + (m.description||'')).toLowerCase();
      const kw = SUBJECTS[key].keywords;
      return kw.some(k=> text.includes(k.toLowerCase()));
    }

    function cardHTML(m){
      const src = m.thumb || genThumb(m);
      const bg = src ? ` style="background-image:url('${String(src).replace(/'/g,"%27")}')"` : '';
      const label = src ? '' : `썸네일 ${m.id}`;
      return `
      <article class="item" data-id="${m.id}">
        <div class="thumb" data-id="${m.id}" data-title="${m.title}" data-url="${m.url}"${bg}>
          ${label}
          <button class="thumb-del" type="button" title="삭제" aria-label="삭제">×</button>
        </div>
        <div class="meta">
          <div class="title">${m.title}</div>
          <div class="sub">${m.description||""}</div>
        </div>
      </article>`;
    }

    function render(){
      let list=MODELS
        .filter(m=>!state.q || (m.title + (m.description||'')).toLowerCase().includes(state.q.toLowerCase()))
        .filter(m=>!state.subject || matchSubject(m, state.subject));

      const total=list.length; const pages=Math.max(1,Math.ceil(total/state.per));
      state.page=Math.min(state.page,pages);
      const start=(state.page-1)*state.per; const pageItems=list.slice(start,start+state.per);

      qs('#count').textContent=`${total}개 결과`;
      qs('#results').innerHTML=pageItems.map(cardHTML).join('');

      // 썸네일 클릭 → 미리보기
      qsa('.thumb').forEach(el=>el.addEventListener('click',()=>openModal(el.dataset.title,el.dataset.url)));

      // 삭제 버튼(로그인 상태에서만 보임 & 동작)
      qsa('.thumb-del').forEach(btn=>{
        btn.style.display = state.isLoggedIn ? 'inline-grid' : 'none';
        btn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          if(!state.isLoggedIn){ alert('로그인이 필요합니다.'); return; }
          const id = btn.closest('.item')?.dataset?.id;
          if(!id) return;
          if(!confirm('정말 삭제하시겠습니까?')) return;
          try{
            const res = await fetch(`/api/models/${id}`, { method:'DELETE', credentials:'include' });
            if(!res.ok){
              if(res.status === 401){ alert('로그인이 필요합니다. 먼저 로그인하세요.'); return; }
              const d = await res.json().catch(()=>({}));
              throw new Error(d.error || 'DELETE_FAILED');
            }
            await loadModels(); render();
          }catch(err){
            alert('삭제 실패: ' + (err.message || 'UNKNOWN'));
          }
        });
      });

      // 페이저
      qs('#pager').innerHTML=Array.from({length:pages})
        .map((_,i)=>`<button ${i+1===state.page?'class="btn primary"':'class="btn"'} data-page="${i+1}">${i+1}</button>`)
        .join('');
      qsa('#pager [data-page]').forEach(b=>b.addEventListener('click',()=>{state.page=+b.dataset.page;render()}));

      // ===== 드래그 앤 드롭 정렬 (현재 페이지 범위 내) =====
      setupDragAndDrop();
    }

    // 검색
    qs('#btnSearch').addEventListener('click',()=>{state.q=qs('#q').value.trim();state.page=1;render();});
    qs('#q').addEventListener('keydown',e=>{if(e.key==='Enter'){state.q=qs('#q').value.trim();state.page=1;render();}});

    // 과목 단일 선택
    qsa('.subject-chk').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        if(chk.checked){
          qsa('.subject-chk').forEach(other=>{ if(other!==chk) other.checked=false; });
          state.subject = chk.value;
        }else{
          state.subject = null;
        }
        state.page=1; render();
      });
    });
    qs('#btnClear').addEventListener('click', ()=>{
      qsa('.subject-chk').forEach(c=>c.checked=false);
      state.subject=null; state.page=1; render();
    });

    // 뷰어 모달 닫기
    qs('#btnClose').addEventListener('click', closeModal);
    qs('#modal').addEventListener('click', e=>{ if(e.target === e.currentTarget) closeModal(); });
    document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeModal(); }, true);

    // ===== Login UI interactions (+ Logout) =====
    const signup = document.getElementById("sign-up");
    const signin = document.getElementById("sign-in");
    const loginin = document.getElementById("login-in");
    const loginup = document.getElementById("login-up");

    signup && signup.addEventListener("click", () => {
      loginin.classList.remove("block");
      loginup.classList.remove("none");
      loginin.classList.add("none");
      loginup.classList.add("block");
    });
    signin && signin.addEventListener("click", () => {
      loginin.classList.remove("none");
      loginup.classList.remove("block");
      loginin.classList.add("block");
      loginup.classList.add("none");
    });

    // API 래퍼
    async function api(path, method='GET', body){
      const res = await fetch(path, {
        method,
        headers: body instanceof FormData ? undefined : { 'Content-Type':'application/json' },
        credentials: 'include',
        body: body ? (body instanceof FormData ? body : JSON.stringify(body)) : undefined
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw Object.assign(new Error(data.error||'요청 실패'), { status: res.status, data });
      return data;
    }

    async function refreshAuthUI(){
      try{
        const me = await api('/api/auth/whoami');
        state.isLoggedIn = !!(me && me.user);
      }catch{ state.isLoggedIn = false; }
      const btnAuth = document.getElementById('btnAuth');
      const btnLogout = document.getElementById('btnLogout');
      if(state.isLoggedIn){
        btnAuth.textContent = '업로드';
        btnLogout.style.display = 'inline-flex';
      }else{
        btnAuth.textContent = '로그인';
        btnLogout.style.display = 'none';
      }
      render(); // 상태 변경 반영
    }

    // 로그인/업로드 모달 열기
    document.getElementById('btnAuth').addEventListener('click', ()=>{
      const mod = state.isLoggedIn ? qs('#modalUpload') : qs('#modalLogin');
      mod.classList.add('open'); mod.focus(); document.body.classList.add('no-scroll');
    });

    // 로그아웃
    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      try{ await api('/api/auth/logout','POST'); }catch(e){ console.warn('logout error', e); }
      state.isLoggedIn = false;
      qs('#modalLogin').classList.remove('open');
      qs('#modalUpload').classList.remove('open');
      document.body.classList.remove('no-scroll');
      await refreshAuthUI();
    });

    // Sign In
    document.getElementById('login-in').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = (document.getElementById('loginUsername').value||'').trim();
      const pw = (document.getElementById('loginPw').value||'').trim();
      if(!username || !pw) return;
      try{
        await api('/api/auth/login','POST',{ username, password: pw });
        await refreshAuthUI();
        const m=qs('#modalLogin'); m.classList.remove('open'); document.body.classList.remove('no-scroll');
      }catch(err){ alert(err.data?.error || '로그인 실패'); }
    });

    // Sign Up
    document.getElementById('login-up')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('signupUsername')?.value?.trim();
      const email = document.getElementById('signupEmail')?.value?.trim();
      const pw = document.getElementById('signupPw')?.value?.trim();
      if(!username || !pw){ alert('Username/Password는 필수입니다.'); return; }
      try{
        await api('/api/auth/signup','POST',{ username, email, password: pw });
        signin?.click();
        alert('가입 완료! 이제 로그인하세요.');
      }catch(err){ alert(err.data?.error || '가입 실패'); }
    });

    // ==== Upload: Dropzone + Preview ====
    const drop = document.getElementById('dropArea');
    const fileInput = document.getElementById('uThumb');
    const pv = document.getElementById('thumbPreview');
    const pvImg = document.getElementById('thumbPreviewImg');
    const pvName = document.getElementById('thumbName');
    const pvSize = document.getElementById('thumbSize');

    function renderPreview(file){
      if(!file){ pv.style.display='none'; return; }
      const url = URL.createObjectURL(file);
      pvImg.src = url;
      pvName.textContent = file.name || 'image.png';
      const kb = Math.round(file.size/1024);
      pvSize.textContent = `${kb.toLocaleString()} KB`;
      pv.style.display='flex';
    }
    fileInput.addEventListener('change', e=>{
      renderPreview(e.target.files?.[0]);
    });
    ;['dragenter','dragover'].forEach(ev=>{
      drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); });
    });
    ;['dragleave','drop'].forEach(ev=>{
      drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); });
    });
    drop.addEventListener('drop', e=>{
      const f = e.dataTransfer.files?.[0];
      if(f){ fileInput.files = e.dataTransfer.files; renderPreview(f); }
    });

    // 업로드 제출(FormData 서버 우선 → 미구현시 메모리)
    document.getElementById('btnResetUpload').addEventListener('click', ()=>{
      document.getElementById('uploadForm').reset();
      pv.style.display='none';
    });

    document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = qs('#uTitle').value.trim();
      const description = qs('#uDesc').value.trim();
      const url = qs('#uUrl').value.trim();
      const subject = qs('#uSubject').value || '';
      const file = qs('#uThumb').files[0];

      if(!title || !description || !url){
        alert('제목/설명/URL은 필수입니다.');
        return;
      }

      let ok=false;
      try{
        const fd = new FormData();
        fd.append('title', title);
        fd.append('description', description);
        fd.append('url', url);
        fd.append('subject', subject);
        if(file) fd.append('thumb', file);
        const res = await fetch('/api/models', { method:'POST', body:fd, credentials:'include' });
        if(res.ok){
          ok=true; await loadModels(); render();
        }
      }catch(e){ console.warn('POST /api/models 실패(서버 미구현일 수 있음)', e); }

      if(!ok){
        let thumb=null; if(file){ thumb = URL.createObjectURL(file); }
        const nextId = (MODELS.reduce((m,cur)=>Math.max(m, cur.id||0), 0) || 0) + 1;
        MODELS.unshift({ id: nextId, title, description, url, subject, thumb });
        render();
      }

      const m=qs('#modalUpload'); m.classList.remove('open'); document.body.classList.remove('no-scroll');
      e.target.reset(); pv.style.display='none'; state.page=1;
    });

    /* ====== [추가] 공통 닫힘 함수 & 모달 닫기 바인딩 ====== */
    function closeAllModals(){
      document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open'));
      document.body.classList.remove('no-scroll');
      const iframe = document.getElementById('viewer');
      if (iframe) iframe.src = '';
    }
    const _modalUpload = document.getElementById('modalUpload');
    if (_modalUpload) {
      _modalUpload.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeAllModals();
      });
    }
    const _btnCloseUpload = document.getElementById('btnCloseUpload');
    _btnCloseUpload && _btnCloseUpload.addEventListener('click', closeAllModals);
    const _modalLogin = document.getElementById('modalLogin');
    if (_modalLogin) {
      _modalLogin.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeAllModals();
      });
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.querySelector('.modal.open')) {
        e.stopPropagation();
        closeAllModals();
      }
    }, true);

    /* ====== [추가] 카드 드래그 앤 드롭 정렬 ====== */
    function setupDragAndDrop(){
      const cards = qsa('#results .item');
      cards.forEach(card=>{
        card.setAttribute('draggable','true');

        card.addEventListener('dragstart', (e)=>{
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', card.dataset.id);
        });

        card.addEventListener('dragend', ()=>{
          card.classList.remove('dragging','drag-over-before','drag-over-after');
          qsa('#results .item').forEach(c=>c.classList.remove('drag-over-before','drag-over-after'));
        });

        card.addEventListener('dragover', (e)=>{
          e.preventDefault();
          const rect = card.getBoundingClientRect();
          const before = (e.clientY < rect.top + rect.height/2);
          qsa('#results .item').forEach(c=>c.classList.remove('drag-over-before','drag-over-after'));
          card.classList.add(before ? 'drag-over-before' : 'drag-over-after');
          e.dataTransfer.dropEffect = 'move';
        });

        card.addEventListener('dragleave', ()=>{
          card.classList.remove('drag-over-before','drag-over-after');
        });

        card.addEventListener('drop', (e)=>{
          e.preventDefault();
          const fromId = e.dataTransfer.getData('text/plain');
          const toId = card.dataset.id;
          if(!fromId || !toId || fromId === toId) return;

          const rect = card.getBoundingClientRect();
          const placeBefore = (e.clientY < rect.top + rect.height/2);

          reorderModelsById(fromId, toId, placeBefore);
          function reorderModelsById(fromId, toId, placeBefore){
  fromId = String(fromId); toId = String(toId);
  let fromIdx = MODELS.findIndex(m=>String(m.id)===fromId);
  let toIdx = MODELS.findIndex(m=>String(m.id)===toId);
  if(fromIdx<0 || toIdx<0) return;

  const [moved] = MODELS.splice(fromIdx,1);
  toIdx = MODELS.findIndex(m=>String(m.id)===toId);
  const insertAt = placeBefore ? toIdx : toIdx + 1;
  MODELS.splice(insertAt, 0, moved);

  render(); // 새 순서로 다시 그림

  // ✅ 여기 추가: 서버에 현재 순서 저장
  persistOrder().catch(()=>{}); // 실패해도 UI는 유지
}

        });
      });
    }

    function reorderModelsById(fromId, toId, placeBefore){
      fromId = String(fromId); toId = String(toId);
      let fromIdx = MODELS.findIndex(m=>String(m.id)===fromId);
      let toIdx = MODELS.findIndex(m=>String(m.id)===toId);
      if(fromIdx<0 || toIdx<0) return;

      const [moved] = MODELS.splice(fromIdx,1); // 먼저 빼고
      // 대상 위치 재탐색(인덱스가 바뀌었을 수 있음)
      toIdx = MODELS.findIndex(m=>String(m.id)===toId);
      const insertAt = placeBefore ? toIdx : toIdx + 1;
      MODELS.splice(insertAt, 0, moved);

      render(); // 새 순서로 다시 그림
    }

    // 시작
    document.getElementById('year').textContent=new Date().getFullYear();
    (async()=>{ await refreshAuthUI(); await loadModels(); render(); })();
    async function persistOrder(){
  try{
    const order = MODELS.map(m => m.id);
    const res = await fetch('/api/models/reorder', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      credentials: 'include',
      body: JSON.stringify({ order })
    });
    if(!res.ok){
      const d = await res.json().catch(()=>({}));
      throw new Error(d.error || 'REORDER_FAILED');
    }
    // 성공 시 아무 것도 안 해도 됨
  }catch(e){
    console.warn('순서 저장 실패:', e.message || e);
    // 필요하면 사용자에게 토스트: alert('순서 저장 실패(로그인 필요?)');
  }
}

  </script>
</body>
</html>
